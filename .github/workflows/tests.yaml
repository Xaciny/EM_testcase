name: all tests

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env from secret
        shell: bash
        env:
          DOTENV: ${{ secrets.DOTENV }}
        run: |
          set -euo pipefail
          [ -n "${DOTENV}" ] || (echo "Secret DOTENV is empty or not set" && exit 1)
          printf "%s" "${DOTENV}" > .env

      - name: Build & start services
        run: |
          set -euo pipefail
          docker compose up --build -d
          docker compose ps

      - name: Test - curl localhost
        shell: bash
        run: |
          set -euo pipefail
          # небольшой retry, чтобы не флапало на старте
          for i in $(seq 1 20); do
            OUT="$(curl -fsS http://localhost || true)"
            if [ "${OUT}" = "Hello from Effective Mobile!" ]; then
              echo "OK"
              exit 0
            fi
            sleep 1
          done
          echo "FAIL: unexpected response"
          docker compose logs --no-color
          exit 1

      - name: Test - backend not exposed on host
        shell: bash
        run: |
          set -euo pipefail
          if curl -fsS http://localhost:8080 >/dev/null 2>&1; then
            echo "FAIL: backend доступен с хоста на 8080"
            exit 1
          fi
          echo "OK"

      - name: Down
        if: always()
        run: docker compose down -v